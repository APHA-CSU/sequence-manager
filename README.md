# sequence-manager

The sequence manager provides NGS software automation capabilities for the CUSP Lab, Weybridge and the CSU SCE3 community using python.

## Architecture

The tech stack for the processing of sequence data is shown below. Illumina machines in Weybridge generate raw `.bcl` sequencing data that is initially stored on `wey-001`, a server in the wet-lab. Following transfer of raw data, a file watcher running on `wey-001` (`bcl_manager`, see below) converts the `.bcl` data into `.fastq` files. The `.fastq` files are then transferred to a S3 bucket in the cloud.

![image](https://user-images.githubusercontent.com/6979169/124135441-b821fd80-da7b-11eb-8c64-eaed1084a8c6.png)


## Remote Access to `wey-001`

`wey-001` can be accessed remotely from a DEFRA computer using SSH. The `illuminashare` user is the common access user that runs production services. If you are not performing maintainance on the production service, it is advised to login with your personal SCE username. To SSH into `wey-001`: 
1. Open putty and ssh into the `ssh.int.sce.network` jumphost (see the [SCE SPOL article](https://defra.sharepoint.com/teams/Team741/SitePages/SSH-access-to-virtual-machine.aspx) for more information). This can be done through putty / cmd / an EC2 instance. 
2. SSH into `wey-001` from the jumphost: ```ssh username@wey-001```

## Bcl Management

`bcl_manager.py` is a file-watcher that runs on `wey-001` for automated: 
- Backup of raw .`bcl` data locally
- Conversion of raw `.bcl` data into `.fastq`
- Upload of `.fastq` files to S3 according to project code

### Installation

To run `bcl_manager.py`, python dependancies need to be installed:

```
cd /path/to/repo/
pip install -r requirements.txt
```

### Running the bcl manager

To run the Bcl Manager, remote into `wey-001` and start the process in a new [screen session](https://linuxize.com/post/how-to-use-linux-screen/):
```
screen
python bcl_manager.py
```
Then detach from the screen using
```
Ctrl+a d
```

The putty instance can then be closed down with the Bcl Manager still running. To return to the screen, remote back into `wey-001` and call:
```
screen -r
```

### Event Handling

By default, `bcl_manager.py` watches `/Illumina/IncomingRuns/` for incoming data. This path corresponds to a location on the SSD in `wey-001` where Illumina machines  store generated bcl data over gigabit ethernet. The high bandwidth connection is required to protect against potential networking bottlenecks that could result in loss of data. File watch events are triggered by the `CopyComplete.txt` file that's generated by the Illumina machines within the directory it creates for storing the run data (see below). The directory name is expected to be formatted: `yymmdd_instrumentID_runnumber_flowcellID`. 

The `bcl_manager.py` event handler makes a copy of the raw bcl data to the `backup-dir` (default: `/Illumina/OutputFastq/BclRuns/`). This default path corresponds to  a location on the high-storage RAID disk on `wey-001`. 

Following back-up, the bcl data is converterd to `fastq.gz` format using Illumina's [bcl2fastq](https://emea.support.illumina.com/sequencing/sequencing_software/bcl-convert.html) under the `fsatq-dir` (default: `/Illumina/OutputFastq/FastqRuns/`). 

The fastq data is then uploaded to S3 according to `s3://{bucket}/{prefix}/{project_code}/{run_id}/` (default: `s3://s3-csu-001/{project_id}/{run_number}/`). The `project_code` is inferred from the bcl directory structure (see below). The `run_id` is formatted as `instrumentid_runnumber` and is also inferred from the bcl directory structure. 

A `meta.json` file is also uploaded to each project code prefix in S3. This file makes it easier to search/access metadata associated with each batch of samples, form databases, and write automation routines. The json file has format:
```
{
    "project_code": "string",
    "instrument_id": "string",
    "run_number": "string",
    "run_id": "string",
    "upload_time": "string":
}
```

### Raw Bcl Example

An example of the raw data that is generated by Illumina machines is shown below. The `CopyComplete.txt` file is transferred last and triggers file-watching events on the `bcl_manager`.

![image](https://user-images.githubusercontent.com/6979169/165509245-9ee64350-6063-4e88-af6c-7906989e0577.png)


### Bcl2Fastq Example

Example output generated by `bcl2fastq` is shown below. The data is stoted in a directory with the same name as the originating bcl data. Fastq files are stored in subdirectories names by their project code.

![image](https://user-images.githubusercontent.com/6979169/165512161-1212f51c-c9d1-4402-bac5-26cd08d17f86.png)


### Maintainance and Error Handling

The Bcl Manager is designed to exit if processing fails in any way. This could occur for a number of reasons:
1. The sample sheet for the Illumina run contains errors
2. Duplicate run id
3. Low space on `wey-001`

Error information is automatically logged and uploaded to `s3://s3-csu-003/aaron/bcl_manager.log` in the event of processing failure. The available space on `wey-001` is also reported at the end of each run.

Once the error has been diagnosed and fixed by a maintainer, `bcl_manager.py` can be restarted as described above.

![image](https://user-images.githubusercontent.com/6979169/124142307-0803c300-da82-11eb-9902-a2404c526c36.png)

